#include <SPI.h>
#include <WiFi101.h>
#include <LiquidCrystal.h>
#include "Adafruit_MQTT.h"
#include "Adafruit_MQTT_Client.h"

//defining ssid and password for the wifi network that the arduino will connect to
#define WLAN_SSD "KNL5"
#define WLAN_PASS "b2ff756d2d"

//defining the adafruit server and port that the arduino will attempt to access
#define AIO_SERVER "io.adafruit.com"
#define AIO_PORT 1883

//adafruit user and key to access the user's feeds
#define AIO_USERNAME "crsullivan13"
#define AIO_KEY "aio_SCEm662Ft7xph8aNJB2MVM8DTFWU"

LiquidCrystal lcd(12, 11, 5, 4, 3, 2);
WiFiClient client;

Adafruit_MQTT_Client mqtt(&client, AIO_SERVER, AIO_PORT, AIO_USERNAME, AIO_KEY);
Adafruit_MQTT_Subscribe printScreen = Adafruit_MQTT_Subscribe(&mqtt, AIO_USERNAME "/feeds/printScreen");

int status = WL_IDLE_STATUS; //local variable to monitor the status of the wifi connection

void MQTT_Connect(){
  int8_t connectionTester;
  Serial.print("Connecting to the MQTT protocol... ");
  //every itteration it will attempt to connect and then check condition
  while((connectionTester = mqtt.connect()) != 0 ){
    Serial.println("Attempting connection");
    mqtt.disconnect();
    delay(3000);
  }
  Serial.println("Connection was made!");
}

void WIFI_connect() {
  Serial.print("Connecting to: ");
  Serial.print(WLAN_SSD);
  while(status != WL_CONNECTED){ //while the ard. isn't connected to the wifi,
    WiFi.disconnect(); //disconnects to make sure each attempt is a new one
    Serial.println("Attempting connection");
    status = WiFi.begin(WLAN_SSD, WLAN_PASS); //begin function returns two values: WL_CONNECTED( it's connected) or WL_IDLE_STATUS (not connected)
    delay(3000);
  }
  Serial.println("Connection successful!");
}

void setup() {
  lcd.begin(16,1); //starts the lcd screen, it will have 81 chars in the first upper line
  lcd.clear(); //clears the screen and sets the cursor to the top left
  Serial.begin(9600);
  delay(10);
  lcd.print("Change via G.A.!");
  WIFI_connect();
  // allows the program to recieve data from the adafruit messages
  mqtt.subscribe(&printScreen);
  MQTT_Connect();
}


void loop() {
  //
  
  Adafruit_MQTT_Subscribe *subscription;
  while((subscription = mqtt.readSubscription(500))){
    if(subscription == &printScreen){
      lcd.clear();
      lcd.print((char*) printScreen.lastread);
    }
  }
  lcd.scrollDisplayRight();
}